<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>é›»æ°—æŸµç‚¹æ¤œãƒŠãƒ“ Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f7f9; }
        #map { height: 45vh; width: 100%; border-bottom: 2px solid #ccc; }
        .controls { padding: 15px; height: 55vh; box-sizing: border-box; overflow-y: auto; }
        
        .btn-flex { display: flex; gap: 10px; margin-bottom: 12px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #recordBtn { background-color: #007bff; }
        #recordBtn.recording { background-color: #dc3545; animation: pulse 2s infinite; }
        #sendBtn { background-color: #28a745; width: 100%; margin-top: 10px; }
        button:active { transform: translateY(1px); box-shadow: none; }
        button:disabled { background-color: #ccc !important; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: white; }
        
        .stats-box { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; display: flex; justify-content: space-around; border: 1px solid #eee; font-size: 14px; }
        .val { color: #dc3545; font-weight: bold; font-size: 16px; }
        #gps-status { font-size: 11px; color: #888; text-align: center; margin-top: 8px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <div class="btn-flex">
        <button id="recordBtn">ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹</button>
    </div>

    <div class="input-group">
        <label>âš¡ é›»åœ§ (V)</label>
        <input type="number" id="voltage" placeholder="ä¾‹: 8500" inputmode="numeric">
    </div>
    
    <div class="input-group">
        <label>ğŸ“ ç‚¹æ¤œãƒ¡ãƒ¢</label>
        <textarea id="memo" rows="2" placeholder="è‰åˆˆã‚Šæ¸ˆã€ç¢å­äº¤æ›ãªã©"></textarea>
    </div>
    
    <button id="sendBtn">âœ… ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
    
    <div class="stats-box">
        <div>è¨˜éŒ²: <span id="count" class="val">0</span> ç‚¹</div>
        <div>è·é›¢: <span id="dist" class="val">0</span> m</div>
    </div>
    <div id="gps-status">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ã€è¨­å®šã€‘GASã®URLã‚’è‡ªåˆ†ã®ã‚‚ã®ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwxOufY73Gwh7cx6mrtR4iDwE1K7pOxw7CTh8i68OWlB0WYHnm7WqlJJCX6TJFmLoIh4w/exec";
    
    const MIN_DISTANCE = 1.0; // 1ãƒ¡ãƒ¼ãƒˆãƒ«å‹•ã„ãŸã‚‰è¨˜éŒ²
    const PRECISION = 6;      // å°æ•°ç‚¹ä»¥ä¸‹6æ¡
    
    let map, marker, pathLine;
    let currentPos = { lat: 0, lng: 0 };
    let pathHistory = []; 
    let totalDistance = 0;
    let isRecording = false;

    // --- 1. åœ°å›³ã®åˆæœŸåŒ– (å›½åœŸåœ°ç†é™¢) ---
    const stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>"
    });
    const ortMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«(å†™çœŸ)</a>"
    });

    map = L.map('map', { center: [35.6812, 139.7671], zoom: 16, layers: [stdMap] });
    L.control.layers({"åœ°ç†é™¢åœ°å›³": stdMap, "èˆªç©ºå†™çœŸ": ortMap}).addTo(map);

    pathLine = L.polyline([], {color: '#dc3545', weight: 5, opacity: 0.8}).addTo(map);

    // --- 2. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å‡¦ç† ---
    
    // ç”°ç•‘ã®å¢ƒç•Œç·š(GeoJSON)ã‚’èª­ã¿è¾¼ã‚€
    // --- ç”°ç•‘ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹é–¢æ•° ---
    async function loadFields() {
        try {
            const response = await fetch('agri_fields.geojson'); // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å
            const geojsonData = await response.json();
    
            L.geoJSON(geojsonData, {
                style: function(feature) {
                    return {
                        color: "#28a745", // æ ç·šã®è‰²ï¼ˆç·‘ï¼‰
                        weight: 2,        // ç·šã®å¤ªã•
                        fillColor: "#28a745", // å¡—ã‚Šã¤ã¶ã—ã®è‰²
                        fillOpacity: 0.2  // é€æ˜åº¦ï¼ˆè–„ãã™ã‚‹ï¼‰
                    };
                },
                onEachFeature: function(feature, layer) {
                    // ã‚‚ã—å±æ€§ãƒ‡ãƒ¼ã‚¿ï¼ˆç”°ç•‘åãªã©ï¼‰ãŒã‚ã‚Œã°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è¡¨ç¤º
                    if (feature.properties) {
                        // "name" ã‚„ "ID" ãªã©ã€ã‚·ã‚§ãƒ¼ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å±æ€§åã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„
                        const fieldName = feature.properties.name || "è€•åœ°ã®ç¨®é¡"; 
                        layer.bindPopup("å ´æ‰€: " + fieldName);
                    }
                }
            }).addTo(map);
        } catch (e) {
            console.error("ç”°ç•‘ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å¤±æ•—:", e);
        }
    }

    // éå»ã®ç‚¹æ¤œåœ°ç‚¹ã‚’èª­ã¿è¾¼ã‚€
    async function loadPastMarkers() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            data.forEach(item => {
                L.circleMarker([item.lat, item.lng], { radius: 5, color: '#ff9800', fillOpacity: 0.8 }).addTo(map)
                 .bindPopup(`éå»ã®ç‚¹æ¤œ: ${item.voltage}V (${new Date(item.date).toLocaleDateString()})`);
            });
        } catch (e) { console.log("éå»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—"); }
    }

    loadFields();
    loadPastMarkers();

    // --- 3. GPSãƒ»è¨˜éŒ²ãƒ­ã‚¸ãƒƒã‚¯ ---

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
            const lat = parseFloat(pos.coords.latitude.toFixed(PRECISION));
            const lng = parseFloat(pos.coords.longitude.toFixed(PRECISION));
            currentPos = { lat, lng };

            if (!marker) {
                marker = L.circleMarker([lat, lng], {radius: 8, color: '#007bff', fillColor: '#007bff', fillOpacity: 1}).addTo(map);
                map.panTo([lat, lng]);
            } else {
                marker.setLatLng([lat, lng]);
            }

            if (isRecording) {
                if (pathHistory.length === 0) {
                    pathHistory.push([lat, lng]);
                } else {
                    const last = pathHistory[pathHistory.length - 1];
                    const d = getDistance(last[0], last[1], lat, lng);
                    if (d >= MIN_DISTANCE) {
                        totalDistance += d;
                        pathHistory.push([lat, lng]);
                        pathLine.setLatLngs(pathHistory);
                    }
                }
            }
            document.getElementById('gps-status').innerText = `ç²¾åº¦: Â±${Math.round(pos.coords.accuracy)}m / ç¾åœ¨: ${lat}, ${lng}`;
            document.getElementById('count').innerText = pathHistory.length;
            document.getElementById('dist').innerText = Math.round(totalDistance);
        }, null, { enableHighAccuracy: true });
    }

    // --- 4. ãƒœã‚¿ãƒ³æ“ä½œ ---

    const recordBtn = document.getElementById('recordBtn');
    recordBtn.addEventListener('click', () => {
        isRecording = !isRecording;
        recordBtn.innerText = isRecording ? "â¹ è¨˜éŒ²ã‚’åœæ­¢" : "ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ã‚’å†é–‹";
        recordBtn.classList.toggle('recording', isRecording);
    });

    document.getElementById('sendBtn').addEventListener('click', async () => {
        const voltage = document.getElementById('voltage').value;
        const memo = document.getElementById('memo').value;
        if (!voltage) return alert("é›»åœ§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        const wkt = pathHistory.length > 1 ? `LINESTRING(${pathHistory.map(p => `${p[1]} ${p[0]}`).join(", ")})` : "";

        try {
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ lat: currentPos.lat, lng: currentPos.lng, voltage, memo, path: wkt }) });
            alert("é€ä¿¡æˆåŠŸï¼ãƒ«ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
            document.getElementById('voltage').value = "";
            document.getElementById('memo').value = "";
            pathHistory = [];
            pathLine.setLatLngs([]);
            totalDistance = 0;
            isRecording = false;
            recordBtn.innerText = "ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹";
            recordBtn.classList.remove('recording');
            document.getElementById('count').innerText = "0";
            document.getElementById('dist').innerText = "0";
            loadPastMarkers(); // æœ€æ–°ã®ç‚¹ã‚’å†èª­ã¿è¾¼ã¿
        } catch (e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); }
        btn.disabled = false;
        btn.innerText = "âœ… ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãƒªã‚»ãƒƒãƒˆ";
    });
</script>
</body>
</html>

