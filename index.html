<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>é›»æ°—æŸµç‚¹æ¤œãƒŠãƒ“ Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #f4f7f9; }
        #map { height: 45vh; width: 100%; border-bottom: 2px solid #ccc; }
        .controls { padding: 15px; height: 55vh; box-sizing: border-box; overflow-y: auto; }
        
        .btn-flex { display: flex; gap: 10px; margin-bottom: 12px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #recordBtn { background-color: #007bff; }
        #recordBtn.recording { background-color: #dc3545; animation: pulse 2s infinite; }
        #sendBtn { background-color: #28a745; width: 100%; margin-top: 10px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
        input[type="number"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: white; }
        input[type="file"] { width: 100%; padding: 8px; font-size: 14px; background: white; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .stats-box { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; display: flex; justify-content: space-around; border: 1px solid #eee; font-size: 14px; }
        .val { color: #dc3545; font-weight: bold; font-size: 16px; }
        #gps-status { font-size: 11px; color: #888; text-align: center; margin-top: 8px; }
        
        /* å‡¡ä¾‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .legend { background: white; padding: 10px; line-height: 24px; color: #333; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 13px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 10px; opacity: 0.7; border: 1px solid #999; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <div class="btn-flex">
        <button id="recordBtn">ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹</button>
    </div>
    <div class="input-group">
        <label>âš¡ é›»åœ§ (V)</label>
        <input type="number" id="voltage" placeholder="ä¾‹: 8500" inputmode="numeric">
    </div>
    
    <div class="input-group">
        <label>ğŸ“· ç¾åœ°å†™çœŸ</label>
        <input type="file" id="photoInput" accept="image/*" capture="environment">
    </div>

    <div class="input-group">
        <label>ğŸ“ ç‚¹æ¤œãƒ¡ãƒ¢</label>
        <textarea id="memo" rows="2" placeholder="è‰åˆˆã‚Šæ¸ˆãªã©"></textarea>
    </div>
    
    <button id="sendBtn">âœ… ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
    <div class="stats-box">
        <div>è¨˜éŒ²: <span id="count" class="val">0</span> ç‚¹</div>
        <div>è·é›¢: <span id="dist" class="val">0</span> m</div>
    </div>
    <div id="gps-status">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // â–¼ GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwxOufY73Gwh7cx6mrtR4iDwE1K7pOxw7CTh8i68OWlB0WYHnm7WqlJJCX6TJFmLoIh4w/exec";
    
    let map, marker, pathLine;
    let currentPos = { lat: 0, lng: 0 };
    let pathHistory = []; 
    let totalDistance = 0;
    let isRecording = false;

    // --- 1. åœ°å›³åˆæœŸåŒ– ---
    const stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: "åœ°ç†é™¢æ¨™æº–" });
    const ortMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', { attribution: "åœ°ç†é™¢å†™çœŸ" });

    map = L.map('map', { 
        center: [35.832577, 140.145721], // æŒ‡å®šã®åˆæœŸåº§æ¨™
        zoom: 16, 
        layers: [stdMap] 
    });
    
    L.control.layers({"åœ°å›³": stdMap, "å†™çœŸ": ortMap}).addTo(map);

    // é‡ãªã‚Šé †ã®ãƒšã‚¤ãƒ³è¨­å®š
    map.createPane('bgPane').style.zIndex = 300;     
    map.createPane('boundaryPane').style.zIndex = 400; 
    map.createPane('fieldPane').style.zIndex = 410;    
    map.createPane('markerPane').style.zIndex = 650;   

    pathLine = L.polyline([], {color: '#dc3545', weight: 5, opacity: 0.8}).addTo(map);

    // --- 2. å‡¡ä¾‹ ---
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<i style="background: rgba(0, 123, 255, 0.3); border: 2px solid #007bff"></i> ç”°<br>';
        div.innerHTML += '<i style="background: rgba(139, 69, 19, 0.3); border: 2px solid #8b4513"></i> ç•‘<br>';
        div.innerHTML += '<i style="background: none; border: 2px dashed #ff33ff; height:0; margin-top:10px; border-width: 3px 0 0 0;"></i> é›†è½å¢ƒç•Œ';
        return div;
    };
    legend.addTo(map);

    // --- 3. GeoJSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---

    async function loadVillageBoundary() {
        try {
            const res = await fetch('village_boundary.geojson');
            const data = await res.json();
            L.geoJSON(data, {
                pane: 'boundaryPane',
                style: { color: "#ff33ff", weight: 3, dashArray: '5, 10', fill: false },
                interactive: false
            }).addTo(map);
        } catch (e) { console.log("é›†è½å¢ƒç•Œèª­è¾¼ã‚¨ãƒ©ãƒ¼"); }
    }

    async function loadAgriFields() {
        try {
            const res = await fetch('agri_fields.geojson');
            const data = await res.json();
            L.geoJSON(data, {
                pane: 'fieldPane',
                style: function(feature) {
                    const type = feature.properties["è€•åœ°ã®ç¨®é¡"];
                    if (type === "ç”°") {
                        return { color: "#007bff", fillColor: "#007bff", fillOpacity: 0.3, weight: 2, dashArray: '' };
                    } else if (type === "ç•‘") {
                        return { color: "#8b4513", fillColor: "#8b4513", fillOpacity: 0.3, weight: 2, dashArray: '' };
                    }
                    return { color: "#28a745", weight: 1, fillOpacity: 0.1, dashArray: '' };
                }
            }).addTo(map);
        } catch (e) { console.log("ç”°ç•‘ãƒ‡ãƒ¼ã‚¿èª­è¾¼ã‚¨ãƒ©ãƒ¼"); }
    }

    async function loadPastMarkers() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            data.forEach(item => {
                L.circleMarker([item.lat, item.lng], { radius: 5, color: '#ff9800', fillOpacity: 0.8, pane: 'markerPane' }).addTo(map)
                 .bindPopup(`éå»: ${
