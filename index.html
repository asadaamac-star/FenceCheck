<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>é›»æ°—æŸµç‚¹æ¤œãƒŠãƒ“ Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #f4f7f9; }
        #map { height: 45vh; width: 100%; border-bottom: 2px solid #ccc; }
        .controls { padding: 15px; height: 55vh; box-sizing: border-box; overflow-y: auto; }
        
        .btn-flex { display: flex; gap: 10px; margin-bottom: 12px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #recordBtn { background-color: #007bff; }
        #recordBtn.recording { background-color: #dc3545; animation: pulse 2s infinite; }
        #sendBtn { background-color: #28a745; width: 100%; margin-top: 10px; }
        button:active { transform: translateY(1px); box-shadow: none; }
        button:disabled { background-color: #ccc !important; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: white; }
        
        .stats-box { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; display: flex; justify-content: space-around; border: 1px solid #eee; font-size: 14px; }
        .val { color: #dc3545; font-weight: bold; font-size: 16px; }
        #gps-status { font-size: 11px; color: #888; text-align: center; margin-top: 8px; }
        
        /* å‡¡ä¾‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .legend { background: white; padding: 6px 10px; line-height: 18px; color: #555; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 12px; }
        .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; opacity: 0.7; border: 1px solid #999; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <div class="btn-flex">
        <button id="recordBtn">ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹</button>
    </div>

    <div class="input-group">
        <label>âš¡ é›»åœ§ (V)</label>
        <input type="number" id="voltage" placeholder="ä¾‹: 8500" inputmode="numeric">
    </div>
    
    <div class="input-group">
        <label>ğŸ“ ç‚¹æ¤œãƒ¡ãƒ¢</label>
        <textarea id="memo" rows="2" placeholder="è‰åˆˆã‚Šæ¸ˆã€ç¢å­äº¤æ›ãªã©"></textarea>
    </div>
    
    <button id="sendBtn">âœ… ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
    
    <div class="stats-box">
        <div>è¨˜éŒ²: <span id="count" class="val">0</span> ç‚¹</div>
        <div>è·é›¢: <span id="dist" class="val">0</span> m</div>
    </div>
    <div id="gps-status">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwxOufY73Gwh7cx6mrtR4iDwE1K7pOxw7CTh8i68OWlB0WYHnm7WqlJJCX6TJFmLoIh4w/exec";
    const MIN_DISTANCE = 1.0; 
    const PRECISION = 6;      
    
    let map, marker, pathLine;
    let currentPos = { lat: 0, lng: 0 };
    let pathHistory = []; 
    let totalDistance = 0;
    let isRecording = false;

    // --- 1. åœ°å›³åˆæœŸåŒ– (å›½åœŸåœ°ç†é™¢) ---
    const stdMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: "åœ°ç†é™¢æ¨™æº–" });
    const ortMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', { attribution: "åœ°ç†é™¢å†™çœŸ" });

    map = L.map('map', { center: [35.6812, 139.7671], zoom: 16, layers: [stdMap] });
    L.control.layers({"åœ°å›³": stdMap, "å†™çœŸ": ortMap}).addTo(map);

    pathLine = L.polyline([], {color: '#dc3545', weight: 5, opacity: 0.8}).addTo(map);

    // --- 2. å‡¡ä¾‹ã®è¿½åŠ  ---
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<i style="background: #007bff"></i> ç”°<br>';
        div.innerHTML += '<i style="background: #a52a2a"></i> ç•‘<br>';
        div.innerHTML += '<i style="border: 1px dashed #ff33ff; background: none"></i> é›†è½å¢ƒç•Œ';
        return div;
    };
    legend.addTo(map);

    // --- 3. GeoJSONèª­ã¿è¾¼ã¿å‡¦ç† ---

    // ç”°ç•‘ãƒ‡ãƒ¼ã‚¿ (agri_fields.geojson)
    async function loadAgriFields() {
        try {
            const res = await fetch('agri_fields.geojson');
            const data = await res.json();
            L.geoJSON(data, {
                style: function(feature) {
                    const type = feature.properties["è€•åœ°ã®ç¨®é¡"];
                    if (type === "ç”°") {
                        return { color: "#007bff", weight: 2, fillOpacity: 0.3, fillColor: "#007bff" };
                    } else if (type === "ç•‘") {
                        return { color: "#a52a2a", weight: 2, fillOpacity: 0.3, fillColor: "#a52a2a" };
                    } else {
                        return { color: "#28a745", weight: 2, fillOpacity: 0.2, fillColor: "#28a745" };
                    }
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup("ç¨®é¡: " + (feature.properties["è€•åœ°ã®ç¨®é¡"] || "ä¸æ˜"));
                }
            }).addTo(map);
        } catch (e) { console.log("ç”°ç•‘ãƒ‡ãƒ¼ã‚¿èª­è¾¼ã‚¨ãƒ©ãƒ¼", e); }
    }

    // é›†è½å¢ƒç•Œ (village_boundary.geojson)
    async function loadVillageBoundary() {
        try {
            const res = await fetch('village_boundary.geojson');
            const data = await res.json();
            L.geoJSON(data, {
                style: { color: "#ff33ff", weight: 3, dashArray: '5, 10', fill: false },
                interactive: false
            }).addTo(map);
        } catch (e) { console.log("é›†è½å¢ƒç•Œèª­è¾¼ã‚¨ãƒ©ãƒ¼", e); }
    }

    async function loadPastMarkers() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            data.forEach(item => {
                L.circleMarker([item.lat, item.lng], { radius: 5, color: '#ff9800', fillOpacity: 0.8 }).addTo(map)
                 .bindPopup(`éå»: ${item.voltage}V (${new Date(item.date).toLocaleDateString()})`);
            });
        } catch (e) { console.log("éå»ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¤±æ•—"); }
    }

    loadAgriFields();
    loadVillageBoundary();
    loadPastMarkers();

    // --- 4. GPSãƒ­ã‚¸ãƒƒã‚¯ ---

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
            const lat = parseFloat(pos.coords.latitude.toFixed(PRECISION));
            const lng = parseFloat(pos.coords.longitude.toFixed(PRECISION));
            currentPos = { lat, lng };

            if (!marker) {
                marker = L.circleMarker([lat, lng], {radius: 8, color: '#007bff', fillColor: '#007bff', fillOpacity: 1}).addTo(map);
                map.panTo([lat, lng]);
            } else { marker.setLatLng([lat, lng]); }

            if (isRecording) {
                if (pathHistory.length === 0) { pathHistory.push([lat, lng]); }
                else {
                    const last = pathHistory[pathHistory.length - 1];
                    const d = getDistance(last[0], last[1], lat, lng);
                    if (d >= MIN_DISTANCE) {
                        totalDistance += d;
                        pathHistory.push([lat, lng]);
                        pathLine.setLatLngs(pathHistory);
                    }
                }
            }
            document.getElementById('gps-status').innerText = `ç²¾åº¦: Â±${Math.round(pos.coords.accuracy)}m / ç¾åœ¨: ${lat}, ${lng}`;
            document.getElementById('count').innerText = pathHistory.length;
            document.getElementById('dist').innerText = Math.round(totalDistance);
        }, null, { enableHighAccuracy: true });
    }

    // --- 5. æ“ä½œãƒœã‚¿ãƒ³ ---

    const recordBtn = document.getElementById('recordBtn');
    recordBtn.addEventListener('click', () => {
        isRecording = !isRecording;
        recordBtn.innerText = isRecording ? "â¹ è¨˜éŒ²ã‚’åœæ­¢" : "ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ã‚’å†é–‹";
        recordBtn.classList.toggle('recording', isRecording);
    });

    document.getElementById('sendBtn').addEventListener('click', async () => {
        const voltage = document.getElementById('voltage').value;
        const memo = document.getElementById('memo').value;
        if (!voltage) return alert("é›»åœ§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        const wkt = pathHistory.length > 1 ? `LINESTRING(${pathHistory.map(p => `${p[1]} ${p[0]}`).join(", ")})` : "";

        try {
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ lat: currentPos.lat, lng: currentPos.lng, voltage, memo, path: wkt }) });
            alert("é€ä¿¡æˆåŠŸï¼");
            document.getElementById('voltage').value = "";
            document.getElementById('memo').value = "";
            pathHistory = [];
            pathLine.setLatLngs([]);
            totalDistance = 0;
            isRecording = false;
            recordBtn.innerText = "ğŸ‘£ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹";
            recordBtn.classList.remove('recording');
            document.getElementById('count').innerText = "0";
            document.getElementById('dist').innerText = "0";
            loadPastMarkers(); 
        } catch (e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); }
        btn.disabled = false;
        btn.innerText = "âœ… ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãƒªã‚»ãƒƒãƒˆ";
    });
</script>
</body>
</html>
